<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>
    Being Dynamic in a Static Language – Hemera's Zettelbox
  </title>
  
    
      <meta property='og:description' content />
      <meta property='og:site_name' content="Hemera's Zettelbox" />
      <meta property='og:type' content='website' />
      <meta property='og:title' content='Being Dynamic in a Static Language' />
    
    
      <base href='/' />
      <link href='favicon.svg' rel='icon' />
    
    <script>
  window.MathJax = {
    startup: {
      ready: () => {
        MathJax.startup.defaultReady();
      }
    }
  };
</script>
<script async id='MathJax-script' src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>

<!-- Prism.js --><link href='https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/themes/prism-tomorrow.min.css' rel='stylesheet' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js'></script>


  
  <link href='tailwind.css?instanceId=6dfe61fc-255b-4bf2-a05f-09311eb90079' rel='stylesheet' type='text/css' />

  <!-- Heist error element -->
  <style type='text/css'>
    strong.error {
      color: lightcoral;
      font-size: 90%;
      font-family: monospace;
    }
  </style>
  <!-- What goes in this file will appear on near the end of <head>--><link rel='preload' href='_emanote-static/fonts/Maven_Pro/MavenPro-VariableFont_wght.ttf' as='font' type='font/ttf' crossorigin />

<style>
  @font-face {
    font-family: 'MavenPro';
    /* FIXME: This ought to be: ${ema:emanoteStaticLayerUrl}/fonts/Maven_Pro/MavenPro-VariableFont_wght.ttf */
    src: url(_emanote-static/fonts/Maven_Pro/MavenPro-VariableFont_wght.ttf) format("truetype");
    font-display: swap;
  }

  body {
    font-family: 'MavenPro', sans-serif;
    /* font-variation-settings: 'wght'300; */
  }

  a.mavenLinkBold {
    font-variation-settings: 'wght'500;
  }

  strong {
    font-variation-settings: 'wght'500;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  header,
  .header-font {
    font-family: 'MavenPro', sans-serif;
  }
</style>

  <head-main></head-main>
</head>

<!-- DoNotFormat -->



<!-- DoNotFormat -->

<body class='bg-gray-400 overflow-y-scroll'>
  
    <div class='container mx-auto'>

      <nav id='breadcrumbs' class='w-full text-gray-700 md:hidden'>
  <div class='flex justify-left'>
    <div class='w-full px-2 py-2 bg-gray-50'>
      <ul class='flex flex-wrap text-lg'>
        <li class='inline-flex items-center'>
          
            
              <img style='width: 1rem;' src='favicon.svg' />
            
          
        </li>
        
          
            <li class='inline-flex items-center'>
              <a class='px-1 font-bold' href=''>
                Welcome
              </a>
              <svg fill='currentColor' viewBox='0 0 20 20' class='w-auto h-5 text-gray-400'>
                <path fill-rule='evenodd' d='M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z' clip-rule='evenodd'></path>
              </svg>
            </li>
          
            <li class='inline-flex items-center'>
              <a class='px-1 font-bold' href='programming'>
                programming
              </a>
              <svg fill='currentColor' viewBox='0 0 20 20' class='w-auto h-5 text-gray-400'>
                <path fill-rule='evenodd' d='M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z' clip-rule='evenodd'></path>
              </svg>
            </li>
          
            <li class='inline-flex items-center'>
              <a class='px-1 font-bold' href='programming/rust'>
                Rust
              </a>
              <svg fill='currentColor' viewBox='0 0 20 20' class='w-auto h-5 text-gray-400'>
                <path fill-rule='evenodd' d='M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z' clip-rule='evenodd'></path>
              </svg>
            </li>
          
        
      </ul>
    </div>
    <button class='inline px-2 py-1 text-white bg-yellow-600 outline-none cursor-pointer focus:outline-none' title='Toggle sidebar' type='button' onclick="toggleHidden('sidebar')">
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 6h16M4 12h16M4 18h16'></path>
      </svg>
    </button>
    <script>
      function toggleHidden(elemId) {
        document.getElementById(elemId).classList.toggle("hidden");
      }
    </script>
  </div>
</nav>

      <div id='container' class='flex flex-nowrap flex-col md:flex-row bg-gray-50 md:mt-8 md:shadow-2xl md:mb-8'>
        <!-- Sidebar column -->
        <nav id='sidebar' class='flex-shrink hidden leading-relaxed md:block md:sticky md:top-0 md:h-full md:w-48 xl:w-64'>
          <div class='px-2 py-2 text-gray-800'>

            <div id='indexing-links' class='flex flex-row float-right p-2 space-x-2 text-gray-500'>
              <a href='-/tags' title='View tags'>
                <svg style='width: 1rem;' class='hover:text-yellow-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
                  </path>
                </svg>
              </a>
              <a href='-/all' title='Expand full tree'>
                <svg style='width: 1rem;' class='hover:text-yellow-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
                  </path>
                </svg>
              </a>
            </div>

            <div id='site-logo' class='pl-2'>
              <div class='flex items-center my-2 space-x-2 justify-left'>
                <a href='' title='Go to Home'>
                  
                    
                      <!-- The style width attribute here is to prevent huge
                      icon from displaying at those rare occasions when Tailwind
                      hasn't kicked in immediately on page load 
                      -->
                      <img style='width: 2.5rem;' class='transition transform hover:scale-110 hover:opacity-80' src='favicon.svg' />
                    
                  
                </a>
                <a class='font-bold truncate' title='Go to Home' href=''>
                  Home
                </a>
              </div>
            </div>

            
              <!-- Variable bindings for this tree-->
  
    
      
      
    



  
  

<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 flex-shrink-0 inline text-gray-700' viewBox='0 0 20 20' fill='currentColor'>
        <path fill-rule='evenodd' d='M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z' clip-rule='evenodd'></path>
        <path d='M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z'></path>
      </svg>
      
  
    <a class='font-bold hover:underline truncate' title='Blog Entries' href='blog'>
      Blog Entries
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
      <!-- Variable bindings for this tree-->
  
    
      
    
    



  


<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg class='w-4 h-4 flex-shrink-0 inline' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z'>
        </path>
      </svg>
    
  
    <a class='hover:underline truncate' title='Licensing this Blog' href='blog/2022-05-30'>
      Licensing this Blog
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
  
</div>
    
  
</div>
            
              <!-- Variable bindings for this tree-->
  
    
      
      
    



  
  

<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 flex-shrink-0 inline text-gray-700' viewBox='0 0 20 20' fill='currentColor'>
        <path fill-rule='evenodd' d='M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z' clip-rule='evenodd'></path>
        <path d='M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z'></path>
      </svg>
      
  
    <a class='font-bold hover:underline truncate' title='Furry Stuff' href='furry_stuff'>
      Furry Stuff
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
      <!-- Variable bindings for this tree-->
  
    
      
    
    



  


<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg class='w-4 h-4 flex-shrink-0 inline' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z'>
        </path>
      </svg>
    
  
    <a class='hover:underline truncate' title='All things Fursuits' href='furry_stuff/fursuits'>
      All things Fursuits
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
  
</div>
    
      <!-- Variable bindings for this tree-->
  
    
      
    
    



  


<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg class='w-4 h-4 flex-shrink-0 inline' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z'>
        </path>
      </svg>
    
  
    <a class='hover:underline truncate' title='Hemera' href='furry_stuff/hemera'>
      Hemera
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
  
</div>
    
  
</div>
            
              <!-- Variable bindings for this tree-->
  
    
      
      
    



  
  

<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 flex-shrink-0 inline text-gray-700' viewBox='0 0 20 20' fill='currentColor'>
        <path fill-rule='evenodd' d='M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z' clip-rule='evenodd'></path>
        <path d='M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z'></path>
      </svg>
      
  
    <a class='font-bold hover:underline truncate' title='NixOS and Nix' href='nixos'>
      NixOS and Nix
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
      <!-- Variable bindings for this tree-->
  
    
      
    
    



  


<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg class='w-4 h-4 flex-shrink-0 inline' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z'>
        </path>
      </svg>
    
  
    <a class='hover:underline truncate' title='Flakes' href='nixos/flakes'>
      Flakes
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
  
</div>
    
  
</div>
            
              <!-- Variable bindings for this tree-->
  
    
      
      
    



  
  

<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 flex-shrink-0 inline text-gray-700' viewBox='0 0 20 20' fill='currentColor'>
        <path fill-rule='evenodd' d='M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z' clip-rule='evenodd'></path>
        <path d='M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z'></path>
      </svg>
      
  
    <a class='font-bold hover:underline truncate' title='programming' href='programming'>
      programming
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
      <!-- Variable bindings for this tree-->
  
    
      
      
    



  
  

<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 flex-shrink-0 inline text-gray-700' viewBox='0 0 20 20' fill='currentColor'>
        <path fill-rule='evenodd' d='M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z' clip-rule='evenodd'></path>
        <path d='M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z'></path>
      </svg>
      
  
    <a class='font-bold hover:underline truncate' title='Rust' href='programming/rust'>
      Rust
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
      <!-- Variable bindings for this tree-->
  
  


  


<!-- Rendering of this tree -->
<div class='pl-2'>
  <!-- Node's rootLabel-->
  <div class='flex items-center my-2 space-x-2 justify-left'>
    
    
      <svg class='w-4 h-4 flex-shrink-0 inline' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'>
        </path>
      </svg>
      
  
    <a class='font-bold text-yellow-600 hover:underline truncate' title='Being Dynamic in a Static Language' href='programming/rust/dynamic_in_static'>
      Being Dynamic in a Static Language
    </a>
    
      
  </div>

  <!-- Node's children forest, displayed only on active trees
    TODO: Use <details> to toggle visibility?
  -->
  
    
  
</div>
    
  
</div>
    
  
</div>
            

          </div>
        </nav>

        <!-- Main body column -->
        <div class='flex-1 w-full overflow-x-auto bg-white'>
          <main class='px-4 py-4'>
            <h1 class='flex items-end justify-center mb-4 p-3 bg-yellow-100 text-5xl font-extrabold text-black rounded'>
  <a class='z-40 tracking-tighter '>
    Being Dynamic in a Static Language
  </a>
</h1>
            <article class='overflow-auto'>
  <!-- What goes in this file will appear on top of note body-->
  
    <p class='mb-3'>
      <a href='programming/rust' class='text-yellow-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkNormal'>Rust</a> is a statically compiled language. As such it excels, and is geared towards, static program structures. This means that some restrictions apply:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          Every type needs to have a known size or, if its a trait, it needs to be behind a <code class='py-0.5 px-0.5 bg-gray-100'>dyn T</code> reference
        </li>
      
        <li>
          Traits need to be <a href='https://doc.rust-lang.org/reference/items/traits.html#object-safety' class='text-yellow-600 hover:underline' target='_blank' rel='noopener'>object safe</a> to qualify being allowed in a <code class='py-0.5 px-0.5 bg-gray-100'>dyn T</code> reference
        </li>
      
    </ul>
  
    <p class='mb-3'>
      During my work the following requirements came up:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-decimal list-inside'>
      
        <li>
          Have a known list of possible components
        </li>
      
        <li>
          Be able to instantiate any number and combination of these components
        </li>
      
        <li>
          Establish <em>typed</em> connections between the instances of the components
        </li>
      
    </ul>
  
    <p class='mb-3'>
      In this case, the idea is be to have a precompiled binary that is ‘batteries-included’ in which the user can then activate a number of instances of its components and wire-up a data flow between them. After several months of trying out different systems and continously refining our ideas we’ve found a nice pattern that I want to document here.
    </p>
  
    <p class='mb-3'>
      <strong>Note</strong>: This is not a tutorial, and more of a guided explanation. <strong>Rust knowledge is required!</strong>
    </p>
  <hr class='mb-3' /><h2 id='laying-the-groundwork' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'>Laying the groundwork</h2>
    <p class='mb-3'>
      Let’s assume the components we care about are called ’Plugin’s. So we will need a trait for that:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>trait Plugin {
    async fn starting(&mut self) -&gt; Result&lt;()&gt; {
        Ok(())
    }
    async fn run(&self) -&gt; Result&lt;()&gt;;
    async fn stopping(&mut self) -&gt; Result&lt;()&gt; {
        Ok(())
    }
}</code></pre></div>
    <p class='mb-3'>
      (I’m using async fns in traits, if that’s not yet available feel free to use <a href='https://docs.rs/async-trait' class='text-yellow-600 hover:underline' target='_blank' rel='noopener'><code class='py-0.5 px-0.5 bg-gray-100'>async-trait</code></a> to work around it.)
    </p>
  
    <p class='mb-3'>
      The <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code> trait will be the heart piece of this whole endeavour. It can be used as such for example:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>
struct WatchFolder {
    path: PathBuf,
}

impl Plugin for WatchFolder {
    async fn run(&self) -&gt; Result&lt;()&gt; {
        while let Ok(event) = watch_folder(self.path).await {
            info!(?event, "Received folder event");
        }
    }
}</code></pre></div>
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      What is that <code class='py-0.5 px-0.5 bg-gray-100'>watch_folder</code> function and the <code class='py-0.5 px-0.5 bg-gray-100'>info!</code> macro? And why are you not specifiying the Error in those <code class='py-0.5 px-0.5 bg-gray-100'>Results</code>?
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      Good that you mention those Neikos, they are just placeholders, so that anyone reading this doesn’t have to think in ‘foos’ or ‘bars’ and instead can just focus on the heart of the issue. Whereas for the error type, its not important and readers are expected to fill that in. It’s not meant to be copy-pasted!
    </p>
  
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      Won’t it just confuse them even more?
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      Maybe? But who knows, I prefer writing semi-realistic code. Moving on…
    </p>
  
    <p class='mb-3'>
      Now that we’ve seen how the <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code> object is meant to be seen, let’s use it!
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>async fn main() -&gt; Result&lt;()&gt; {
    let mut watcher = WatchFolder { path: PathBuf::from("./src") };

    watcher.starting().await?;
    watcher.run().await?;
    watcher.stopping().await?;
}</code></pre></div>
    <p class='mb-3'>
      Great! That’s easy and fairly straightforward. Now comes the first hurdle. We want to spawn several of them. How could we do this?
    </p>
  
    <p class='mb-3'>
      Well, we’re programmers, and if we have several, we’ll just loop!
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>async fn main() -&gt; Result&lt;()&gt; {
    let paths = ["./src", "/etc/hosts"];

    let watchers = paths.iter()
        .map(|p| WatchFolder { path: p.into() })
        .collect::&lt;Vec&lt;_&gt;&gt;();

    for watcher in watchers {
        watcher.starting().await?;
    }

    let done_watchers = watchers
        .into_iter()
        .map(|watcher| async move {
            watcher.run().await; 
            watcher 
        })
        .collect::&lt;FuturesUnordered&gt;()
        .collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;().await?;

    for watcher in watchers {
        watcher.stopping().await?;
    }
}</code></pre></div>
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      Whew that got more complicated!
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      Yeah, well we’re doing async stuff! But don’t worry, it’s all fairly straightforward:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          First we get a list of paths (Could just as well be from user input, or a config file, etc…)
        </li>
      
        <li>
          We then <code class='py-0.5 px-0.5 bg-gray-100'>.iter</code>ate over that list and construct some <code class='py-0.5 px-0.5 bg-gray-100'>WatchFolder</code> instances, and put everything into a <code class='py-0.5 px-0.5 bg-gray-100'>Vec</code>
        </li>
      
        <li>
          We then start each of them one after the other
        </li>
      
        <li>
          Then, I create a future, <em>but don’t await it yet</em>, which I then collect into a <code class='py-0.5 px-0.5 bg-gray-100'>FuturesUnordered</code> through the <code class='py-0.5 px-0.5 bg-gray-100'>Extend</code> trait.
        </li>
      
        <li>
          Since <code class='py-0.5 px-0.5 bg-gray-100'>FuturesUnordered</code> is a <code class='py-0.5 px-0.5 bg-gray-100'>Stream</code> I can then collect from that and make it a <code class='py-0.5 px-0.5 bg-gray-100'>Result&lt;Vec&lt;_&gt;&gt;</code>, pass on any errors and get back the watchers!
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          They had to be moved into the future, since we don’t want to have borrows in our <code class='py-0.5 px-0.5 bg-gray-100'>Future</code>s (its generally a headache)
        </li>
      
    </ul>
  
        </li>
      
    </ul>
  <h2 id='stepping-up-the-difficulty' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'>Stepping up the difficulty</h2>
    <p class='mb-3'>
      What if we now have multiple <em>kinds</em> of plugins? Let’s define a new one!
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>struct SimpleWebserver {
    port: u16,
    directory: PathBuf,
    server_handle: Option&lt;ServerHandle&gt;,
}

impl SimpleWebserver {
    pub fn new(port: u16, directory: PathBuf) -&gt; Self {
        SimpleWebserver {
            port, 
            directory, 
            server_handle: None,
        }
    }
}

impl Plugin for SimpleWebserver {
    async fn starting(&mut self) -&gt; Result&lt;()&gt; {
        self.server_handle = Some(webserver::start(self.port, &self.directory).await?);

        Ok(())
    }
}</code></pre></div>
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      What does the webserver do?
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      That’s just a detail, it could do whatever you want! It’s just Rust code after all.
    </p>
  
    <p class='mb-3'>
      Now, let’s try to instantiate both a <code class='py-0.5 px-0.5 bg-gray-100'>WatchFolder</code> and a <code class='py-0.5 px-0.5 bg-gray-100'>SimpleWebserver</code>!
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>async fn main() -&gt; Result&lt;()&gt; {
    let plugins = vec![WatchFolder { path: PathBuf::from("./src") }, SimpleWebserver::new(3456, PathBuf::from(".")];

    // .. call starting, run, and stopping
}</code></pre></div>
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      Oh-oh! That doesn’t compile! They are not of the same type.
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      Yup, and now we’re leaving the static world and making our first steps into the dynamic world.
    </p>
  <h4 id='trait-objects-to-the-rescue' class='mt-6 mb-2 text-2xl font-bold text-gray-700'>Trait Objects to the rescue</h4>
    <p class='mb-3'>
      All the way at the top, we’ve defined our <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code> trait. It’s a fairly simple trait, and thus allows us to pack it behind a fat pointer and ‘erase’ the concrete type, keeping only the information conveyed by the <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code> trait. This is then called a ‘Trait object’. If you want to read more, check the <a href='https://doc.rust-lang.org/reference/types/trait-object.html' class='text-yellow-600 hover:underline' target='_blank' rel='noopener'>rust reference</a> on it!
    </p>
  
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      What’s a fat pointer?
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      A fat pointer is a pointer with some associated metadata. In this case it would be a table of methods that correspond to the methods in the <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code> trait.
    </p>
  
    <p class='mb-3'>
      The concept of the so-called ‘call table’ is represented through <code class='py-0.5 px-0.5 bg-gray-100'>dyn Plugin</code>. <em>Everytime you see a <code class='py-0.5 px-0.5 bg-gray-100'>dyn</code>, you should think “Ah! It could be anything, so I can only do generic stuff to it”</em>
    </p>
  
    <p class='mb-3'>
      Now, the issue is that <code class='py-0.5 px-0.5 bg-gray-100'>dyn Plugin</code> is just ‘something’ represented as a table of methods, so how big is it? We can’t know! So Rust prevents us to use it ‘as-is’ and requires us to put it behind some form of pointer. There’s a few we can pick from:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          <code class='py-0.5 px-0.5 bg-gray-100'>&dyn Plugin</code>
        </li>
      
        <li>
          <code class='py-0.5 px-0.5 bg-gray-100'>Box&lt;dyn Plugin&gt;</code>
        </li>
      
        <li>
          <code class='py-0.5 px-0.5 bg-gray-100'>Rc&lt;dyn Plugin&gt;</code>
        </li>
      
        <li>
          <code class='py-0.5 px-0.5 bg-gray-100'>Arc&lt;dyn Plugin&gt;</code>
        </li>
      
    </ul>
  
    <p class='mb-3'>
      And surely more that I’ve missed, they all have different properties, but since we want to ‘own’ the resulting <code class='py-0.5 px-0.5 bg-gray-100'>Plugin</code>s we will use <code class='py-0.5 px-0.5 bg-gray-100'>Box&lt;dyn Plugin&gt;</code>.
    </p>
  <h2 id='stepping-up-the-difficulty-contd' class='inline-block mt-6 mb-4 text-4xl font-bold text-gray-700 border-b-2'>Stepping up the difficulty (contd.)</h2>
    <p class='mb-3'>
      TODO:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          
    <svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mb-1 text-gray-600 stroke-current' fill='none' viewBox='0 0 28 28'><desc>☐</desc><rect stroke-width='3' x='2' y='2' width='24' height='24' rx='3'></rect></svg>
<span>
  
      Explain how to use <code class='py-0.5 px-0.5 bg-gray-100'>Vec&lt;Box&lt;dyn Plugin&gt;&gt;</code>
    
</span>

  
        </li>
      
        <li>
          
    <svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mb-1 text-gray-600 stroke-current' fill='none' viewBox='0 0 28 28'><desc>☐</desc><rect stroke-width='3' x='2' y='2' width='24' height='24' rx='3'></rect></svg>
<span>
  
      Explain how a second trait is needed to construct it based on a given config
    
</span>

  
        </li>
      
        <li>
          
    <svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mb-1 text-gray-600 stroke-current' fill='none' viewBox='0 0 28 28'><desc>☐</desc><rect stroke-width='3' x='2' y='2' width='24' height='24' rx='3'></rect></svg>
<span>
  
      Explain how communication can be done
    
</span>

  
        </li>
      
        <li>
          
    <svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mb-1 text-gray-600 stroke-current' fill='none' viewBox='0 0 28 28'><desc>☐</desc><rect stroke-width='3' x='2' y='2' width='24' height='24' rx='3'></rect></svg>
<span>
  
      Explain how this communication can be typed by using <code class='py-0.5 px-0.5 bg-gray-100'>Box&lt;dyn Any&gt;</code>
    
</span>

  
        </li>
      
    </ul>
  
  <div class='flex items-center justify-center mt-2'>
  <a class='text-gray-300 hover:text-yellow-600 text-sm' title='Edit this page on GitHub' href='https://github.com/TheNeikos/hemera.systems/edit/master/content/programming/rust/dynamic_in_static.md'>
    <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
      <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'></path>
    </svg>
  </a>
</div>
<hr class='m-2' />
<div class='flex items-center'>
  <img src='/hemera_laptop.jpg' alt='Hemera sitting in front of a laptop with a NixOS logo on it.' />
</div>

</article>
            <div class='flex flex-col lg:flex-row lg:space-x-2'>
              
              
            </div>
            
  <section class='flex flex-wrap items-end justify-center my-4 space-x-2 space-y-2 font-mono text-sm'>
    
  </section>

            <!-- What goes in this file will at the very end of the main div -->
          </main>
        </div>
      </div>
      <footer class='flex items-center justify-center mt-2 mb-8 space-x-4 text-center text-gray-800'>
  
  <div>
    <a href='' title='Go to Home page'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-yellow-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'></path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/all' title='View Index'>
      <svg class='w-6 h-6 hover:text-yellow-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='/' title='Generated by Emanote 0.6.7.0'>
      <img class='w-6 h-6 hover:text-yellow-700' src='/favicon.svg' />
    </a>
  </div>
  <div>
    <a href='-/tags' title='View tags'>
      <svg class='w-6 h-6 hover:text-yellow-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/tasks' title='View tasks'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-yellow-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'></path>
      </svg>
    </a>
  </div>
</footer>
<footer class='flex m-3 items-center justify-center text-xs'>
 <p xmlns:cc='http://creativecommons.org/ns#' xmlns:dct='http://purl.org/dc/terms/'>
    <a property='dct:title' rel='cc:attributionURL' href='https://blog.hemera.systems'>Hemera Systems Blog</a>
    by
    <a rel='cc:attributionURL dct:creator' property='cc:attributionName' href='https://blog.hemera.systems'>Marcel Müller</a>
    is licensed under 
    <a href='http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1' target='_blank' rel='license noopener noreferrer' style='display:inline-block;'>
        Attribution-ShareAlike 4.0 International
    </a>
    <a href='http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1' target='_blank' rel='license noopener noreferrer' style='display:inline-block;'>
        <span class='flex items-center'>
            <img style='height:16px!important;margin-left:3px;vertical-align:text-bottom;' src='https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1' />
            <img style='height:16px!important;margin-left:3px;vertical-align:text-bottom;' src='https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1' />
            <img style='height:16px!important;margin-left:3px;vertical-align:text-bottom;' src='https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1' />
        </span>
    </a>
 </p> 
</footer>

    </div>
  
</body>

</html>
